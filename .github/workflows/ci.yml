name: CI

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  test:
    name: Test & Analyze
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 30
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Clean and Get Dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Build Runner (Generate Dart Files)
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Format Check (Exclude .mocks files)
        run: dart format --set-exit-if-changed $(git ls-files '*.dart' ':!:*.mocks.dart')

      - name: Analyze Code
        run: flutter analyze

      - name: Run Tests with Coverage
        run: flutter test --coverage

      - name: Upload Coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          flag-name: run-${{ matrix.platform }}
          parallel: true

  build:
    name: Build Validation
    needs: test
    strategy:
      matrix:
        include:
          - platform: ubuntu-latest
            build-type: android
          - platform: macos-latest
            build-type: ios
          - platform: windows-latest
            build-type: windows
    runs-on: ${{ matrix.platform }}
    timeout-minutes: 45
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java (for Android)
        if: matrix.build-type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Cache Gradle (Android)
        if: matrix.build-type == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache CocoaPods (iOS)
        if: matrix.build-type == 'ios'
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Get Dependencies
        run: |
          flutter clean
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs

      # Android Build Validation
      - name: Build APK (Android)
        if: matrix.build-type == 'android'
        env:
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_NAME: ${{ secrets.FB_APP_NAME }}
          GH_OAUTH_CLIENT_ID: ${{ secrets.GH_OAUTH_CLIENT_ID }}
          GH_OAUTH_CLIENT_SECRET: ${{ secrets.GH_OAUTH_CLIENT_SECRET }}
        run: |
          flutter build apk --debug \
            --dart-define=FB_APP_ID=$FB_APP_ID \
            --dart-define=FB_APP_NAME=$FB_APP_NAME \
            --dart-define=GITHUB_OAUTH_CLIENT_ID=$GH_OAUTH_CLIENT_ID \
            --dart-define=GITHUB_OAUTH_CLIENT_SECRET=$GH_OAUTH_CLIENT_SECRET

      # iOS Build Validation
      - name: Build iOS (No Code Signing)
        if: matrix.build-type == 'ios'
        env:
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_NAME: ${{ secrets.FB_APP_NAME }}
          GH_OAUTH_CLIENT_ID: ${{ secrets.GH_OAUTH_CLIENT_ID }}
          GH_OAUTH_CLIENT_SECRET: ${{ secrets.GH_OAUTH_CLIENT_SECRET }}
        run: |
          rm -f ios/Podfile.lock
          flutter build ios --debug --no-codesign \
            --dart-define=FB_APP_ID=$FB_APP_ID \
            --dart-define=FB_APP_NAME=$FB_APP_NAME \
            --dart-define=GITHUB_OAUTH_CLIENT_ID=$GH_OAUTH_CLIENT_ID \
            --dart-define=GITHUB_OAUTH_CLIENT_SECRET=$GH_OAUTH_CLIENT_SECRET

      # Windows Build Validation
      - name: Build Windows
        if: matrix.build-type == 'windows'
        env:
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_NAME: ${{ secrets.FB_APP_NAME }}
          GH_OAUTH_CLIENT_ID: ${{ secrets.GH_OAUTH_CLIENT_ID }}
          GH_OAUTH_CLIENT_SECRET: ${{ secrets.GH_OAUTH_CLIENT_SECRET }}
        run: |
          flutter build windows --debug \
            --dart-define=FB_APP_ID=$FB_APP_ID \
            --dart-define=FB_APP_NAME=$FB_APP_NAME \
            --dart-define=GITHUB_OAUTH_CLIENT_ID=$GH_OAUTH_CLIENT_ID \
            --dart-define=GITHUB_OAUTH_CLIENT_SECRET=$GH_OAUTH_CLIENT_SECRET

  coverage-finish:
    name: Finalize Coverage
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Finalize Coveralls Reporting
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true

  # Optional: Build preview APK for PRs
  preview:
    name: Build Preview APK
    if: github.event_name == 'pull_request'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Build Preview APK
        env:
          FB_APP_ID: ${{ secrets.FB_APP_ID }}
          FB_APP_NAME: ${{ secrets.FB_APP_NAME }}
          GH_OAUTH_CLIENT_ID: ${{ secrets.GH_OAUTH_CLIENT_ID }}
          GH_OAUTH_CLIENT_SECRET: ${{ secrets.GH_OAUTH_CLIENT_SECRET }}
        run: |
          flutter clean
          flutter pub get
          flutter packages pub run build_runner build --delete-conflicting-outputs
          flutter build apk --release \
            --dart-define=FB_APP_ID=$FB_APP_ID \
            --dart-define=FB_APP_NAME=$FB_APP_NAME \
            --dart-define=GITHUB_OAUTH_CLIENT_ID=$GH_OAUTH_CLIENT_ID \
            --dart-define=GITHUB_OAUTH_CLIENT_SECRET=$GH_OAUTH_CLIENT_SECRET

      - name: Upload Preview APK
        uses: actions/upload-artifact@v4
        with:
          name: preview-apk-pr-${{ github.event.pull_request.number }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

      - name: Comment PR with APK Link
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“± Preview APK built successfully! Download from the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
            })
